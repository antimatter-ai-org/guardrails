services:
  redis:
    image: redis:7.2-alpine
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 15

  guardrails:
    build:
      context: ../..
      dockerfile: Dockerfile
    environment:
      GR_REDIS_URL: redis://redis:6379/0
      GR_RUNTIME_MODE: cpu
      GR_ENABLE_NEMOTRON: ${GR_ENABLE_NEMOTRON:-true}
      GR_PYTRITON_INIT_TIMEOUT_S: "240"
      GR_LOG_LEVEL: DEBUG
      GR_MODEL_DIR: /models
      GR_OFFLINE_MODE: ${GR_OFFLINE_MODE:-false}
      HF_TOKEN: ${HF_TOKEN:-}
      HUGGINGFACE_HUB_TOKEN: ${HF_TOKEN:-}
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8080/readyz', timeout=3).read()"]
      interval: 10s
      timeout: 5s
      retries: 90
      start_period: 30s
    ports:
      - "8080:8080"
    volumes:
      - ./model_cache:/models

  router:
    build:
      context: .
      dockerfile: Dockerfile
    env_file:
      - .env
    environment:
      OPENROUTER_MODEL: ${OPENROUTER_MODEL:-openrouter/openai/gpt-4o-mini}
      GUARDRAILS_URL: ${GUARDRAILS_URL:-http://guardrails:8080}
      GUARDRAILS_POLICY_ID: ${GUARDRAILS_POLICY_ID:-external_default}
      GUARDRAILS_TIMEOUT_S: ${GUARDRAILS_TIMEOUT_S:-15}
      GUARDRAILS_OUTPUT_SCOPE: ${GUARDRAILS_OUTPUT_SCOPE:-FULL}
    depends_on:
      guardrails:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:4000/health/readiness', timeout=3).read()"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 10s
    ports:
      - "4000:4000"

  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    environment:
      OPENAI_API_BASE_URL: http://router:4000/v1
      OPENAI_API_KEY: ${LITELLM_MASTER_KEY}
      WEBUI_AUTH: "False"
      OFFLINE_MODE: "true"
      RAG_EMBEDDING_MODEL_AUTO_UPDATE: "false"
      RAG_RERANKING_MODEL_AUTO_UPDATE: "false"
      WHISPER_MODEL_AUTO_UPDATE: "false"
    depends_on:
      router:
        condition: service_healthy
    ports:
      - "3000:8080"
    volumes:
      - open-webui-data:/app/backend/data

volumes:
  open-webui-data:
