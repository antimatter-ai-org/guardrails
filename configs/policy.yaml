version: 1
default_policy: external_default

policies:
  external_default:
    mode: mask
    min_score: 0.55
    storage_ttl_seconds: 3600
    placeholder_prefix: "GR"
    detectors:
      - ru_pii_regex
      - identifier_regex
      - network_pii_regex
      - date_pii_regex
      - en_pii_regex
      - code_secret_regex
      - high_entropy_secret
      - natasha_ner_ru
      - gliner_pii_multilingual

  onprem_passthrough:
    mode: passthrough
    min_score: 1.0
    storage_ttl_seconds: 300
    placeholder_prefix: "GR"
    detectors: []

  strict_block:
    mode: block
    min_score: 0.6
    storage_ttl_seconds: 3600
    placeholder_prefix: "GR"
    detectors:
      - ru_pii_regex
      - identifier_regex
      - network_pii_regex
      - date_pii_regex
      - en_pii_regex
      - code_secret_regex

detector_definitions:
  ru_pii_regex:
    type: regex
    enabled: true
    params:
      patterns:
        - name: ru_phone
          label: RU_PHONE
          pattern: "(?<!\\d)(?:\\+7|8)[\\s(]*\\d{3}[\\s)-]*\\d{3}[\\s-]*\\d{2}[\\s-]*\\d{2}(?!\\d)"
          score: 0.94
        - name: ru_passport
          label: RU_PASSPORT
          pattern: "(?<!\\d)\\d{4}[\\s-]?\\d{6}(?!\\d)"
          score: 0.97
        - name: ru_snils
          label: RU_SNILS
          pattern: "(?<!\\d)\\d{3}-\\d{3}-\\d{3}[\\s-]?\\d{2}(?!\\d)"
          score: 0.98
        - name: ru_inn
          label: RU_INN
          pattern: "(?<!\\d)(?:\\d{10}|\\d{12})(?!\\d)"
          score: 0.78
        - name: ru_ogrn
          label: RU_OGRN
          pattern: "(?<!\\d)(?:\\d{13}|\\d{15})(?!\\d)"
          score: 0.78
        - name: bank_card
          label: PAYMENT_CARD
          pattern: "(?<!\\d)(?:\\d[ -]*?){13,19}(?!\\d)"
          score: 0.75
        - name: email
          label: EMAIL
          pattern: "[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}"
          flags: ["IGNORECASE"]
          score: 0.96

  en_pii_regex:
    type: regex
    enabled: true
    params:
      patterns:
        - name: us_ssn
          label: US_SSN
          pattern: "(?<!\\d)\\d{3}-\\d{2}-\\d{4}(?!\\d)"
          score: 0.99
        - name: iban
          label: IBAN
          pattern: "\\b[A-Z]{2}\\d{2}[A-Z0-9]{11,30}\\b"
          score: 0.83
        - name: swift
          label: SWIFT
          pattern: "\\b[A-Z]{6}[A-Z0-9]{2}(?:[A-Z0-9]{3})?\\b"
          score: 0.78
        - name: intl_phone
          label: PHONE
          pattern: "(?<!\\d)(?:\\+\\d{1,3}[\\s-]?)?(?:\\(\\d{2,4}\\)|\\d{2,4})[\\s-]\\d{2,4}[\\s-]\\d{2,4}(?:[\\s-]\\d{1,4})?(?!\\d)"
          score: 0.72

  identifier_regex:
    type: regex
    enabled: true
    params:
      patterns:
        - name: military_number_ru_compact
          label: MILITARY_INDIVIDUAL_NUMBER
          pattern: "(?i)\\bв/ч[- ]?\\d{3,6}\\b"
          score: 0.93
        - name: military_number_hyphen
          label: MILITARY_INDIVIDUAL_NUMBER
          pattern: "(?i)\\b(?:\\d{2}-[A-ZА-ЯЁ]{2}-\\d{3,6}|[A-ZА-ЯЁ]{2}-\\d{3,6})\\b"
          score: 0.9
        - name: vehicle_plate_ru_ua
          label: VEHICLE_NUMBER
          pattern: "(?i)\\b[АВЕКМНОРСТУХABEKMHOPCTYX]{1,2}\\s?\\d{3,4}\\s?[АВЕКМНОРСТУХABEKMHOPCTYX]{1,2}\\b"
          score: 0.9
        - name: vehicle_vin
          label: VEHICLE_VIN
          pattern: "\\b[A-HJ-NPR-Z0-9]{17}\\b"
          score: 0.96
        - name: document_series_number
          label: DOCUMENT_NUMBER
          pattern: "(?<!\\d)\\d{2}\\s?\\d{2}\\s?№\\s?\\d{4,8}(?!\\d)"
          score: 0.93
        - name: document_code_hyphen
          label: DOCUMENT_NUMBER
          pattern: "(?i)\\b[A-ZА-ЯЁ]{2,5}-\\d{3,}\\b"
          score: 0.84
        - name: document_numeric_hyphen
          label: DOCUMENT_NUMBER
          pattern: "(?<!\\d)\\d{5,}(?:-\\d{1,4}){1,4}(?!\\d)"
          score: 0.82

  network_pii_regex:
    type: regex
    enabled: true
    params:
      patterns:
        - name: ipv4_or_cidr
          label: IP_ADDRESS
          pattern: "(?<![\\d.])(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}(?:/(?:[0-9]|[12]\\d|3[0-2]))?(?![\\d.])"
          score: 0.99
        - name: ipv6_full
          label: IP_ADDRESS
          pattern: "(?i)\\b(?:[0-9a-f]{1,4}:){2,7}[0-9a-f]{1,4}\\b"
          score: 0.97
        - name: ipv6_compressed
          label: IP_ADDRESS
          pattern: "(?i)\\b(?:[0-9a-f]{1,4}:){1,7}:[0-9a-f:]{0,17}\\b"
          score: 0.95

  date_pii_regex:
    type: regex
    enabled: true
    params:
      patterns:
        - name: date_iso_ymd
          label: DATE
          pattern: "(?<!\\d)(?:19|20)\\d{2}[-./](?:0?[1-9]|1[0-2])[-./](?:0?[1-9]|[12]\\d|3[01])(?!\\d)"
          score: 0.96
        - name: date_dmy
          label: DATE
          pattern: "(?<!\\d)(?:0?[1-9]|[12]\\d|3[01])[-./](?:0?[1-9]|1[0-2])[-./](?:19|20)?\\d{2}(?!\\d)"
          score: 0.95
        - name: date_month_year
          label: DATE
          pattern: "(?<!\\d)(?:0?[1-9]|1[0-2])[./](?:19|20)\\d{2}(?!\\d)"
          score: 0.92
        - name: date_quarter
          label: DATE
          pattern: "(?i)(?<!\\d)(?:19|20)\\d{2}[.\\-/\\s]?q[1-4](?!\\d)"
          score: 0.88
        - name: date_year_range
          label: DATE
          pattern: "(?<!\\d)(?:19|20)\\d{2}\\s*[–-]\\s*(?:19|20)\\d{2}(?:\\s*г(?:одах|ода|г)?)?"
          score: 0.83

  code_secret_regex:
    type: secret_regex
    enabled: true
    params:
      patterns:
        - name: jwt
          label: SECRET_JWT
          pattern: "\\beyJ[A-Za-z0-9_-]{10,}\\.[A-Za-z0-9_-]{10,}\\.[A-Za-z0-9_-]{10,}\\b"
          score: 0.97

  high_entropy_secret:
    type: entropy
    enabled: true
    params:
      min_length: 24
      entropy_threshold: 3.7

  natasha_ner_ru:
    type: natasha
    enabled: true
    params:
      score: 0.68

  gliner_pii_multilingual:
    type: gliner
    enabled: true
    params:
      model_name: "urchade/gliner_multi-v2.1"
      threshold: 0.62
      labels:
        - "person"
        - "organization"
        - "location"
        - "email"
        - "phone number"
        - "passport number"
        - "credit card number"
        - "api key"
      chunking:
        enabled: true
        max_tokens: 320
        overlap_tokens: 64
        max_chunks: 64
        boundary_lookback_tokens: 24
