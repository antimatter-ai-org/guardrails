default_policy: external_default

policies:
  external_default:
    mode: mask
    analyzer_profile: external_rich
    min_score: 0.55
    storage_ttl_seconds: 3600
    placeholder_prefix: "GR"

  onprem_passthrough:
    mode: passthrough
    analyzer_profile: passthrough_profile
    min_score: 1.0
    storage_ttl_seconds: 300
    placeholder_prefix: "GR"

  strict_block:
    mode: block
    analyzer_profile: strict_profile
    min_score: 0.60
    storage_ttl_seconds: 3600
    placeholder_prefix: "GR"

  external_nemotron_only:
    mode: mask
    analyzer_profile: external_nemotron_only
    min_score: 0.40
    storage_ttl_seconds: 3600
    placeholder_prefix: "GR"

analyzer_profiles:
  external_rich:
    analysis:
      recognizers:
        - phone_number_lib
        - ip_address_lib
        - ru_pii_regex
        - identifier_regex
        - network_pii_regex
        - url_regex
        - date_pii_regex
        - en_pii_regex
        - code_secret_regex
        - high_entropy_secret
        - gliner_pii_multilingual
        - nemotron_pii_token_classifier

  strict_profile:
    analysis:
      recognizers:
        - phone_number_lib
        - ip_address_lib
        - ru_pii_regex
        - identifier_regex
        - network_pii_regex
        - url_regex
        - date_pii_regex
        - en_pii_regex
        - code_secret_regex
        - high_entropy_secret

  external_nemotron_only:
    analysis:
      recognizers:
        - phone_number_lib
        - ip_address_lib
        - ru_pii_regex
        - identifier_regex
        - network_pii_regex
        - url_regex
        - date_pii_regex
        - en_pii_regex
        - code_secret_regex
        - high_entropy_secret
        - nemotron_pii_token_classifier_extended

  passthrough_profile:
    analysis:
      recognizers: []

recognizer_definitions:
  phone_number_lib:
    type: phone
    enabled: true
    params:
      score: 0.92
      min_digits: 10
      regions: ["RU", "UA", "US", "GB", "DE", "PL", "KZ"]

  ip_address_lib:
    type: ip
    enabled: true
    params:
      score: 0.995

  ru_pii_regex:
    type: regex
    enabled: true
    params:
      patterns:
        - name: ru_phone
          label: PHONE_NUMBER
          pattern: "(?<!\\d)(?:\\+7|8)[\\s(]*\\d{3}[\\s)-]*\\d{3}[\\s-]*\\d{2}[\\s-]*\\d{2}(?!\\d)"
          score: 0.97
        - name: ru_passport
          label: DOCUMENT_NUMBER
          pattern: "(?<![+\\d])\\d{4}[\\s-]\\d{6}(?!\\d)"
          score: 0.90
        - name: ru_snils
          label: DOCUMENT_NUMBER
          pattern: "(?<!\\d)\\d{3}-\\d{3}-\\d{3}[\\s-]?\\d{2}(?!\\d)"
          score: 0.98
        - name: ru_inn
          label: TIN
          pattern: "(?<![+\\d])(?:\\d{10}|\\d{12})(?!\\d)"
          score: 0.78
        - name: ru_ogrn
          label: DOCUMENT_NUMBER
          pattern: "(?<!\\d)(?:\\d{13}|\\d{15})(?!\\d)"
          score: 0.78
        - name: bank_card
          label: CREDIT_CARD
          pattern: "(?<!\\d)(?:\\d[ -]*?){13,19}(?!\\d)"
          score: 0.75
        - name: email
          label: EMAIL_ADDRESS
          pattern: "[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}"
          flags: ["IGNORECASE"]
          score: 0.96

  en_pii_regex:
    type: regex
    enabled: true
    params:
      patterns:
        - name: us_ssn
          label: US_SSN
          pattern: "(?<!\\d)\\d{3}-\\d{2}-\\d{4}(?!\\d)"
          score: 0.99
        - name: iban
          label: IBAN_CODE
          pattern: "\\b[A-Z]{2}\\d{2}[A-Z0-9]{11,30}\\b"
          score: 0.83
        - name: swift
          label: SWIFT_CODE
          pattern: "\\b[A-Z]{6}[A-Z0-9]{2}(?:[A-Z0-9]{3})?\\b"
          score: 0.78

  identifier_regex:
    type: regex
    enabled: true
    params:
      patterns:
        - name: military_number_ru_compact
          label: MILITARY_INDIVIDUAL_NUMBER
          pattern: "(?i)\\bв/ч[- ]?\\d{3,6}\\b"
          score: 0.93
        - name: military_number_hyphen
          label: MILITARY_INDIVIDUAL_NUMBER
          pattern: "(?i)\\b(?:\\d{2}-[A-ZА-ЯЁ]{2}-\\d{3,6}|[A-ZА-ЯЁ]{2}-\\d{3,6})\\b"
          score: 0.90
        - name: military_number_space
          label: MILITARY_INDIVIDUAL_NUMBER
          pattern: "(?i)\\b[A-ZА-ЯЁ]{2}[ -]\\d{5,8}\\b"
          score: 0.91
        - name: vehicle_plate_ru_ua
          label: VEHICLE_NUMBER
          pattern: "(?i)\\b[АВЕКМНОРСТУХABEKMHOPCTYX]{1,2}\\s?\\d{3,4}\\s?[АВЕКМНОРСТУХABEKMHOPCTYX]{1,2}\\b"
          score: 0.90
        - name: vehicle_vin
          label: DOCUMENT_NUMBER
          pattern: "\\b[A-HJ-NPR-Z0-9]{17}\\b"
          score: 0.96
        - name: document_series_number
          label: DOCUMENT_NUMBER
          pattern: "(?<!\\d)\\d{2}\\s?\\d{2}\\s?№\\s?\\d{4,8}(?!\\d)"
          score: 0.93
        - name: document_code_hyphen
          label: DOCUMENT_NUMBER
          pattern: "(?i)\\b[A-ZА-ЯЁ]{2,5}-\\d{3,}\\b"
          score: 0.84
        - name: document_code_slash
          label: DOCUMENT_NUMBER
          pattern: "(?i)\\b[A-ZА-ЯЁ]-\\d{2,4}/\\d{1,6}\\b"
          score: 0.90
        - name: document_numeric_hyphen
          label: DOCUMENT_NUMBER
          pattern: "(?<!\\d)\\d{5,}(?:-\\d{1,4}){1,4}(?!\\d)"
          score: 0.82
        - name: document_letter_digit_compact
          label: DOCUMENT_NUMBER
          pattern: "(?iu)\\b[А-ЯЁA-Z]{1,3}\\d{6,8}\\b"
          score: 0.90
        - name: document_keyword_number
          label: DOCUMENT_NUMBER
          pattern: "(?iu)\\b(?:passport|паспорт|document|документ|hujjat|id|ид)\\s*(?:№|no\\.?|number|raqam(?:i)?)?\\s*[:\\-]?\\s*[А-ЯЁA-Z]{0,3}\\d{5,10}\\b"
          score: 0.90
        - name: inn_tin_keyword_number
          label: TIN
          pattern: "(?iu)\\b(?:inn|инн|tin)\\s*(?:№|no\\.?|number)?\\s*[:\\-]?\\s*\\d{9,12}\\b"
          score: 0.92

  network_pii_regex:
    type: regex
    enabled: true
    params:
      patterns:
        - name: ipv4_or_cidr
          label: IP_ADDRESS
          pattern: "(?<![\\d.])(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}(?:/(?:[0-9]|[12]\\d|3[0-2]))?(?![\\d.])"
          score: 0.99
        - name: ipv6_full
          label: IP_ADDRESS
          pattern: "(?i)\\b(?:[0-9a-f]{1,4}:){2,7}[0-9a-f]{1,4}\\b"
          score: 0.97
        - name: ipv6_compressed
          label: IP_ADDRESS
          pattern: "(?i)\\b(?:[0-9a-f]{1,4}:){1,7}:[0-9a-f:]{0,17}\\b"
          score: 0.95

  url_regex:
    type: regex
    enabled: true
    params:
      patterns:
        - name: url_http
          label: URL
          pattern: "(?i)\\bhttps?://[^\\s<>()\\\"']+"
          score: 0.97
        - name: url_www
          label: URL
          pattern: "(?i)\\bwww\\.[^\\s<>()\\\"']+"
          score: 0.95
        - name: url_domain_tld
          label: URL
          pattern: "(?i)(?<!@)\\b(?:[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?\\.)+(?:com|net|org|io|ai|ru|ua|by|kz|de|fr|uk|co|edu|gov|info|biz|me|app|dev|site|online|store|tech|cloud|xyz)(?:/[^\\s<>()\\\"']*)?"
          score: 0.75

  date_pii_regex:
    type: regex
    enabled: true
    params:
      patterns:
        - name: date_iso_ymd
          label: DATE_TIME
          pattern: "(?<!\\d)(?:18|19|20|21)\\d{2}[-./](?:0?[1-9]|1[0-2])[-./](?:0?[1-9]|[12]\\d|3[01])(?!\\d)"
          score: 0.96
        - name: date_dmy
          label: DATE_TIME
          pattern: "(?<!\\d)(?:0?[1-9]|[12]\\d|3[01])[-./](?:0?[1-9]|1[0-2])[-./](?:(?:18|19|20|21)\\d{2}|\\d{2})(?!\\d)"
          score: 0.95
        - name: date_month_year
          label: DATE_TIME
          pattern: "(?<!\\d)(?:0?[1-9]|1[0-2])[./](?:18|19|20|21)\\d{2}(?!\\d)"
          score: 0.92
        - name: date_quarter
          label: DATE_TIME
          pattern: "(?i)(?<!\\d)(?:18|19|20|21)\\d{2}[.\\-/\\s]?q[1-4](?!\\d)"
          score: 0.88
        - name: date_year_range
          label: DATE_TIME
          pattern: "(?<!\\d)(?:18|19|20|21)\\d{2}\\s*[–-]\\s*(?:18|19|20|21)\\d{2}(?:\\s*г(?:одах|ода|г)?)?"
          score: 0.83
        - name: date_textual_month_ru_uk_en
          label: DATE_TIME
          pattern: "(?iu)\\b(?:[0-2]?\\d|3[01])\\s+(?:января|февраля|марта|апреля|мая|июня|июля|августа|сентября|октября|ноября|декабря|січня|лютого|березня|квітня|травня|червня|липня|серпня|вересня|жовтня|листопада|грудня|january|february|march|april|may|june|july|august|september|october|november|december)\\s+(?:18|19|20|21)\\d{2}(?:\\s*г(?:ода|од|\\.)?)?\\b"
          score: 0.94

  code_secret_regex:
    type: secret_regex
    enabled: true
    params:
      patterns:
        - name: aws_access_key
          label: API_KEY
          pattern: "\\bAKIA[0-9A-Z]{16}\\b"
          score: 0.97
        - name: github_token
          label: API_KEY
          pattern: "\\bgh[pousr]_[A-Za-z0-9]{36,255}\\b"
          score: 0.97
        - name: slack_token
          label: API_KEY
          pattern: "\\bxox[baprs]-[A-Za-z0-9-]{10,120}\\b"
          score: 0.97
        - name: generic_api_key
          label: API_KEY
          pattern: "(?i)\\b(?:api[_-]?key|secret|token|passwd|password)\\s*[:=]\\s*[\\\"']?[A-Za-z0-9_-]{16,}"
          score: 0.84
        - name: password_assignment_gated
          label: API_KEY
          pattern: "(?i)\\b(?:password|passwd|pwd|passphrase|пароль|секрет|код\\s*доступа)\\b\\s*[:=]\\s*[\\\"']?(?=[^\\s\\\"']{10,64})(?=[^\\s\\\"']*\\d)(?=[^\\s\\\"']*[^A-Za-z\\s\\\"'])[A-Za-z0-9!@#$%^&*()_+\\-={}\\[\\]:;,.?/\\\\|~]+"
          score: 0.78
        - name: token_assignment_gated
          label: API_KEY
          pattern: "(?i)\\b(?:token|secret|api[_-]?key|access[_-]?key|private[_-]?key|auth(?:orization)?|bearer)\\b\\s*[:=]\\s*(?=[A-Za-z0-9._\\-]{16,})(?=.*\\d)(?=.*[._\\-])[A-Za-z0-9._\\-]+"
          score: 0.84
        - name: private_key_block
          label: API_KEY
          pattern: "-----BEGIN (?:RSA |EC |OPENSSH |PGP )?PRIVATE KEY-----"
          score: 0.99
        - name: jwt
          label: API_KEY
          pattern: "\\beyJ[A-Za-z0-9_-]{10,}\\.[A-Za-z0-9_-]{10,}\\.[A-Za-z0-9_-]{10,}\\b"
          score: 0.97

  high_entropy_secret:
    type: entropy
    enabled: true
    params:
      min_length: 24
      entropy_threshold: 3.7
      score: 0.90

  gliner_pii_multilingual:
    type: gliner
    enabled: true
    params:
      model_name: "urchade/gliner_multi-v2.1"
      threshold: 0.62
      labels:
        - "person"
        - "organization"
        - "location"
        - "address"
        - "street address"
        - "city"
        - "district"
        - "postal code"
        - "document number"
        - "tax identification number"
        - "snils"
        - "military number"
        - "vehicle number"
        - "email"
        - "phone number"
        - "ip address"
        - "date"
        - "passport number"
        - "credit card number"
        - "api key"

  natasha_ner_ru:
    type: natasha_ner
    enabled: false
    params:
      score: 0.88
      drop_prompt_imperatives: true
      min_person_chars: 3

  nemotron_pii_token_classifier:
    type: token_classifier
    enabled: true
    params:
      model_name: "scanpatch/pii-ner-nemotron"
      threshold: 0.48
      aggregation_strategy: "simple"
      triton_model_name: "nemotron"
      labels:
        - "address"
        - "address_apartment"
        - "address_building"
        - "address_city"
        - "address_country"
        - "address_district"
        - "address_geolocation"
        - "address_house"
        - "address_postal_code"
        - "address_region"
        - "address_street"
        - "date"
        - "document_number"
        - "email"
        - "ip"
        - "military_individual_number"
        - "mobile_phone"
        - "snils"
        - "tin"
        - "vehicle_number"
      label_mapping:
        address: LOCATION
        address_apartment: LOCATION
        address_building: LOCATION
        address_city: LOCATION
        address_country: LOCATION
        address_district: LOCATION
        address_geolocation: LOCATION
        address_house: LOCATION
        address_postal_code: LOCATION
        address_region: LOCATION
        address_street: LOCATION
        date: DATE_TIME
        document_number: DOCUMENT_NUMBER
        email: EMAIL_ADDRESS
        ip: IP_ADDRESS
        military_individual_number: DOCUMENT_NUMBER
        mobile_phone: PHONE_NUMBER
        snils: DOCUMENT_NUMBER
        tin: TIN
        vehicle_number: DOCUMENT_NUMBER
      entity_thresholds:
        LOCATION: 0.82
        DATE_TIME: 0.78
        DOCUMENT_NUMBER: 0.80
        EMAIL_ADDRESS: 0.72
        IP_ADDRESS: 0.85
        PHONE_NUMBER: 0.78
        TIN: 0.88
      raw_label_thresholds:
        address_geolocation: 0.90
        address: 0.84

  nemotron_pii_token_classifier_extended:
    type: token_classifier
    enabled: true
    params:
      model_name: "scanpatch/pii-ner-nemotron"
      threshold: 0.40
      aggregation_strategy: "max"
      triton_model_name: "nemotron"
      labels:
        - "address"
        - "address_apartment"
        - "address_building"
        - "address_city"
        - "address_country"
        - "address_district"
        - "address_geolocation"
        - "address_house"
        - "address_postal_code"
        - "address_region"
        - "address_street"
        - "date"
        - "document_number"
        - "email"
        - "ip"
        - "military_individual_number"
        - "mobile_phone"
        - "snils"
        - "tin"
        - "vehicle_number"
        - "first_name"
        - "last_name"
        - "middle_name"
        - "name"
        - "name_initials"
        - "nickname"
        - "organization"
      label_mapping:
        address: LOCATION
        address_apartment: LOCATION
        address_building: LOCATION
        address_city: LOCATION
        address_country: LOCATION
        address_district: LOCATION
        address_geolocation: LOCATION
        address_house: LOCATION
        address_postal_code: LOCATION
        address_region: LOCATION
        address_street: LOCATION
        date: DATE_TIME
        document_number: DOCUMENT_NUMBER
        email: EMAIL_ADDRESS
        ip: IP_ADDRESS
        military_individual_number: DOCUMENT_NUMBER
        mobile_phone: PHONE_NUMBER
        snils: DOCUMENT_NUMBER
        tin: TIN
        vehicle_number: DOCUMENT_NUMBER
        first_name: PERSON
        last_name: PERSON
        middle_name: PERSON
        name: PERSON
        name_initials: PERSON
        nickname: PERSON
        organization: ORGANIZATION
      entity_thresholds:
        LOCATION: 0.72
        DATE_TIME: 0.70
        DOCUMENT_NUMBER: 0.72
        EMAIL_ADDRESS: 0.72
        IP_ADDRESS: 0.85
        PHONE_NUMBER: 0.78
        TIN: 0.82
        PERSON: 0.45
        ORGANIZATION: 0.60
      raw_label_thresholds:
        address_geolocation: 0.90
        address: 0.84
